<!DOCTYPE html>
<html>

<html>
<head>
	<title>Time Lapse</title>
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.css' rel='stylesheet' />
	<link rel="stylesheet" type="text/css" href="style/smooth.css"/>
	<link href='https://fonts.googleapis.com/css?family=Bree+Serif' rel='stylesheet' type='text/css'>
</head>

<body onload="importData()">

<h2 class="heading">BOSTON | Food and Drink | TIME LAPSE</h2>

<div id="map"></div>

<script>
L.mapbox.accessToken = 'pk.eyJ1Ijoic3VkZWVwdjUiLCJhIjoiSFAxUk1ITSJ9.2rBStsEu8yfu4zGt-ifGxg';
var map = L.mapbox.map('map', 'sudeepv5.lo0f02dp').setView([42.33,-71.08],12);

var places=[];
var markers=[];
var months=["","January","February","March","April","May","June","July","August","September","October","November","December"];

// Called when either of the slider is moved, 
// Brings in blimps for the restaurants in range and binds data to them.
function drawMarkers()
{
	var low=document.getElementById("anchor-low").value;
	var high=document.getElementById("anchor-high").value;
	var lyear=2006+Math.floor(low/120);
	var lmonth=1+(low/10)%12;
	var hyear=2006+Math.floor(high/120);
	var hmonth=1+(high/10)%12;
	for(var j=0;j<markers.length;j++)
	{
		map.removeLayer(markers[j]);
	}
	markers=[];
	for(var i=0;i<places.length;i++)
	{
		var rest=places[i];
		var licYear=rest.licenseadddttm.substring(0,4);
		var licMonth=rest.licenseadddttm.substring(5,7);
		if(isBetween(lyear,lmonth,licYear, licMonth,hyear,hmonth)){
		var pin=L.marker([rest.location.latitude, rest.location.longitude], {
		icon: L.mapbox.marker.icon({
			'marker-size': 'small',
			'marker-color': '#FF7519',
			'marker-style': 'restaurant'
		})})
		pin.bindPopup(getDetails(rest));
		map.addLayer(pin);
		markers.push(pin);
		}
	}
	document.getElementById("places-info").innerHTML=markers.length+" restaurants were issued licenses between "+
													 months[lmonth]+", "+lyear+" and "+months[hmonth]+", "+hyear;
}

//Returns true iff middle date(y2,m3) is in between (y1,m1), (y3,m3)
/*
console.log(isBetween(2006,01,2006,01,2006,01));
console.log(isBetween(2006,01,2007,01,2006,01));
console.log(isBetween(2006,01,2006,02,2006,01));
console.log(isBetween(2006,01,2008,02,2010,01));
console.log(isBetween(2014,01,2012,02,2010,01));*/

function isBetween(y1,m1,y2,m2,y3,m3)
{
	return (isGreater(y2,m2,y1,m1) && isGreater(y3,m3,y2,m2)) || (isGreater(y2,m2,y3,m3) && isGreater(y1,m1,y2,m2));
}


//Returns true iff (y1,m1) is greater than or equal to (y3,m3)
function isGreater(y1,m1,y2,m2)
{
	if(y1>y2)
		return true;
	else if(y1==y2)
		return (m1>=m2);
	else
		return false;
}

//Returns the details as HTML string to each pin on map
function getDetails(place)
{
	return "<b>Name : </b>"+place.businessname+
	"<br> <b>License Type : </b>"+place.licensecat+
	"<br> <b>License Issue Date : </b>"+place.licenseadddttm+
	"<br> <b>License Status : </b>"+place.licstatus+
	"<br> <b>Takeout : </b>"+((place.descript=="Eating & Drinking w/ Take Out")?"Yes":"No")+
	"<br> <b>Phone : </b>"+place.dayphn+
	"<br> <b>Address : </b>"+place.address+"<br>"+place.city+"<br>"+place.state+" - "+place.zip;
}

//Called on page load, retrives the details of food places from cityofboston.gov
function importData(){
	var xlr=new XMLHttpRequest();
	xlr.open("GET","https://data.cityofboston.gov/resource/gb6y-34cq.json",true);
	xlr.send();
	xlr.onreadystatechange=function(){
	if(xlr.readyState==4 && xlr.status==200)
	{
		places=JSON.parse(xlr.responseText);
	}	
	}
}

</script>
<br>
<div id="anchor-div">
2006<input type="range" id="anchor-low" value="0" min="0" max="1080" step="10" oninput="drawMarkers()">2015<br>
2006<input type="range" id="anchor-high" value="0" min="0" max="1080" step="10" oninput="drawMarkers()">2015
<div>

<div id="places-info">
</div>
<br>
<div class="tip">Tip 1 : Move the sliders to view the licensed restaurants on the map!<br>
				 Tip 2 : Click on blimps to see details of that respective restaurant!</div>
</body>
</html>